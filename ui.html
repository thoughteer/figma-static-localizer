<style>
  * {
    -webkit-box-sizing: border-box;
    box-sizing: border-box;
  }
  .d-block {
    display: block;
  }
  .d-none {
    display: none;
  }
  @font-face {
    font-family: Inter;
    font-style: normal;
    font-weight: 400;
    src: url(https://rsms.me/inter/font-files/Inter-Regular.woff2?v=3.7) format("woff2"),
      url(https://rsms.me/inter/font-files/Inter-Regular.woff?v=3.7) format("woff");
  }

  @font-face {
    font-family: Inter;
    font-style: normal;
    font-weight: 500;
    src: url(https://rsms.me/inter/font-files/Inter-Medium.woff2?v=3.7) format("woff2"),
      url(https://rsms.me/inter/font-files/Inter-Medium.woff2?v=3.7) format("woff");
  }

  @font-face {
    font-family: Inter;
    font-style: normal;
    font-weight: 600;
    src: url(https://rsms.me/inter/font-files/Inter-SemiBold.woff2?v=3.7) format("woff2"),
      url(https://rsms.me/inter/font-files/Inter-SemiBold.woff2?v=3.7) format("woff");
  }

  html,
  body {
    font-family: Inter, sans-serif;
    font-size: 11px;
    font-weight: 400;
    height: 100%;
    letter-spacing: 0.005em;
    line-height: 16px;
    margin: 0;
    padding: 0;
    width: 100%;
  }

  .container {
    display: flex;
    flex-direction: column;
    padding: 0 8px 8px 8px;
    width: 100%;
  }

  .block {
    margin-top: 8px;
  }

  .row {
    display: flex;
    flex-direction: row;
  }

  .row * {
    margin-left: 8px;
  }

  .row *:last-child {
    margin-right: 8px;
  }

  .tab {
    -ms-flex-align: center;
    -webkit-box-align: center;
    align-items: center;
    border-bottom: 1px solid rgba(0, 0, 0, 0.3);
    color: rgba(0, 0, 0, 0.3);
    cursor: default;
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
    font-weight: 500;
    height: 32px;
    justify-content: center;
    padding: 8px 0;
    width: 100%;
  }

  .tab--active {
    border-bottom: 1px solid rgba(0, 0, 0, 0.8);
    color: rgba(0, 0, 0, 0.8);
  }

  .label {
    -ms-flex-align: center;
    -webkit-box-align: center;
    align-items: center;
    color: rgba(0, 0, 0, 0.3);
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
    height: 32px;
    padding: 8px 0;
  }

  input[type="file"] {
    display: none;
  }

  .file {
    -ms-flex-align: center;
    -webkit-box-align: center;
    align-items: center;
    color: rgba(0, 0, 0, 0.5);
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
  }

  .file:hover,
  .file:focus {
    color: rgba(0, 0, 0, 0.8);
  }

  .file:active {
    color: #18a0fb;
  }

  .file svg {
    bottom: 0px;
    margin: 0;
    position: relative;
  }

  .textarea {
    -ms-flex-align: center;
    -webkit-box-align: center;
    align-items: center;
    background-color: #fff;
    border-radius: 2px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0, 0, 0, 0.8);
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    letter-spacing: inherit;
    line-height: inherit;
    margin-bottom: 1px;
    margin-top: 1px;
    min-height: 62px;
    outline: 0;
    padding: 7px 4px 7px 7px;
    resize: none;
    width: 100%;
  }

  .textarea:active,
  .textarea:focus {
    border: 2px solid #18a0fb;
    color: #000;
    padding: 6px 3px 6px 6px;
  }

  .textarea::-moz-selection {
    background-color: rgba(24, 145, 251, 0.3);
    color: #000;
  }

  .textarea::selection {
    background-color: rgba(24, 145, 251, 0.3);
    color: #000;
  }

  .textarea::-webkit-input-placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .textarea:-ms-input-placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .textarea::-ms-input-placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .textarea::placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .input {
    -ms-flex-align: center;
    -webkit-box-align: center;
    align-items: center;
    background-color: #fff;
    border-radius: 2px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0, 0, 0, 0.8);
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    height: 30px;
    letter-spacing: inherit;
    line-height: inherit;
    margin-bottom: 1px;
    margin-top: 1px;
    outline: 0;
    padding: 7px 4px 7px 7px;
    width: 100%;
  }

  .input:active,
  .input:focus {
    border: 2px solid #18a0fb;
    color: #000;
    padding: 6px 3px 6px 6px;
  }

  .input::-moz-selection {
    background-color: rgba(24, 145, 251, 0.3);
    color: #000;
  }

  .input::selection {
    background-color: rgba(24, 145, 251, 0.3);
    color: #000;
  }

  .input::-webkit-input-placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .input:-ms-input-placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .input::-ms-input-placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .input::placeholder {
    color: rgba(0, 0, 0, 0.3);
  }

  .checkbox-wrapper {
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
    padding: 1px 16px 1px 0;
  }

  .checkbox {
    height: 0;
    margin-left: 4px;
    margin-top: 4px;
    outline: 0;
    width: 0;
  }

  .checkbox:after {
    background-color: #fff;
    border-radius: 2px;
    border: 1px solid rgba(0, 0, 0, 0.1);
    content: "";
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
    height: 28px;
    line-height: 28px;
    margin-left: -4px;
    margin-top: -4px;
    width: 28px;
  }

  .checkbox:checked:after {
    background-color: rgba(186, 222, 254, 1);
    border: 5px solid #fff;
    height: 18px;
    margin-left: -3px;
    margin-top: -3px;
    outline: 1px solid rgba(0, 0, 0, 0.1);
    width: 18px;
  }

  .checkbox:focus:after {
    border: 1px solid #18a0fb;
  }

  .checkbox:checked:focus:after {
    border: 5px solid #fff;
    outline: 1px solid #18a0fb;
  }

  .button {
    -ms-flex-negative: 0;
    border-radius: 6px;
    border: 2px solid transparent;
    display: inline-block;
    flex-shrink: 0;
    margin-bottom: 1px;
    margin-top: 1px;
    outline: 0;
    padding: 5px 16px 5px 16px;
  }

  .button--primary {
    background-color: #18a0fb;
    color: #fff;
    font-weight: 500;
    letter-spacing: 0.01em;
  }

  .button--primary:active,
  .button--primary:focus {
    border: 2px solid rgba(0, 0, 0, 0.3);
  }

  .button--primary:disabled {
    background-color: rgba(0, 0, 0, 0.3);
  }

  .button--secondary {
    background-color: #fff;
    border: 1px solid rgba(0, 0, 0, 0.8);
    color: rgba(0, 0, 0, 0.8);
  }

  .button--secondary:active,
  .button--secondary:focus {
    border: 2px solid #18a0fb;
    padding: 4px 15px 4px 15px;
  }

  .button--secondary:disabled {
    border: 1px solid rgba(0, 0, 0, 0.3);
    color: rgba(0, 0, 0, 0.3);
  }

  .select {
    -ms-flex-align: center;
    -webkit-box-align: center;
    align-items: center;
    background-color: #fff;
    border: 1px solid rgba(0, 0, 0, 0.1);
    color: rgba(0, 0, 0, 0.8);
    display: -ms-flexbox;
    display: -webkit-box;
    display: flex;
    font-family: inherit;
    font-size: inherit;
    font-weight: inherit;
    height: 30px;
    letter-spacing: inherit;
    line-height: inherit;
    margin-bottom: 1px;
    margin-top: 1px;
    outline: none;
    width: 100%;
  }

  .select:active,
  .select:focus {
    border: 1px solid #18a0fb;
  }

  .divider {
    background-color: #e5e5e5;
    display: block;
    height: 1px;
    margin: 16px 0 8px 0;
    padding: 0;
    width: auto;
  }

  a {
    color: #18a0fb;
  }
  .switch {
    position: relative;
  }
  .slider {
    position: absolute;
    cursor: pointer;
    top: -4px;
    left: -5px;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    -webkit-transition: 0.4s;
    transition: 0.4s;
  }

  .slider:before {
    position: absolute;
    content: "";
    height: 15px;
    width: 15px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    -webkit-transition: 0.4s;
    transition: 0.4s;
  }

  input:checked + .slider {
    background-color: #2196f3;
  }

  input:focus + .slider {
    box-shadow: 0 0 1px #2196f3;
  }

  input:checked + .slider:before {
    -webkit-transform: translateX(16px);
    -ms-transform: translateX(16px);
    transform: translateX(16px);
  }

  .slider.round {
    border-radius: 34px;
    height: 23px;
    width: 40px;
  }

  .slider.round:before {
    border-radius: 50%;
  }
</style>

<body>
  <div class="row">
    <div class="tab tab--active" with="translation">Translation</div>
  </div>

  <div class="container" id="translation">
    <div class="block">
      <div class="row">
        <div class="label">TSV Dictionary</div>
        <label class="file" for="dictionaryFile" style="margin-left: auto">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            widht="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
            <polyline points="17 8 12 3 7 8"></polyline>
            <line x1="12" y1="3" x2="12" y2="15"></line>
          </svg>
        </label>
        <input type="file" id="dictionaryFile" />
      </div>
      <div class="row">
        <textarea
          class="textarea"
          placeholder="Add TSV Dictionary"
          rows="4"
          id="serializedDictionary"
          wrap="off"
        ></textarea>
      </div>
    </div>
    <div class="block">
      <div class="row">
        <div class="label">To JPG:</div>
      </div>
      <div class="row">
        <label class="switch">
          <input type="checkbox" id="imageExtensionIsJPG" />
          <span class="slider round"></span>
        </label>
      </div>
    </div>

    <div class="block" style="margin-top: 16px">
      <div class="row">
        <input class="input" placeholder="Initial language" id="sourceLanguage" />
        <div class="label">&nbsp;</div>
        <button class="button button--primary" id="translate" disabled>Translate and save</button>
      </div>
      <div class="row">
        <p class="d-none">Now translating: <span id="changingLanguage"></span></p>
      </div>
    </div>
    <div class="divider"></div>
    <div class="block" style="margin-top: 16px">
      <div class="row">
        <button class="button button--primary" id="copy">Translate and preview</button>
      </div>
    </div>
    <div class="divider"></div>
    <div class="block" style="margin-top: 16px">
      <div class="row">
        <button class="button button--primary" id="save">Save selected</button>
      </div>
    </div>
  </div>
  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"
    integrity="sha512-XMVd28F1oH/O71fzwBnV7HucLxVwtxf26XV8P4wPk26EDxuGZ91N8bsOttmnomcCD3CS5ZMRL50H0GgOHvegtg=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  ></script>
  <script type="module">
    var fields = null;
    let language = "";
    onmessage = (event) => {
      const message = event.data.pluginMessage;
      if (!message) {
        return;
      }
      if (message.type === "settings") {
        fields = Object.keys(message.settings);
        fields.forEach((field) => {
          const element = document.getElementById(field);
          element.value = message.settings[field];
        });
      } else if (message.type === "ready") {
        document.getElementById("translate").disabled = false;
        document.getElementById("copy").disabled = false;
        document.getElementById("save").disabled = false;
      } else if (message.type === "content") {
        let zip = new JSZip();
        message.content.forEach((data, idx) => {
          let { lang, bytesMainImage, name, imageExtension } = data;
          let blob = new Blob([bytesMainImage]);
          zip.folder(`${lang}`).file(`${name}.${imageExtension}`, blob);
        });
        zip.generateAsync({ type: "blob" }).then((content) => {
          const blobURL = window.URL.createObjectURL(content);
          const link = document.createElement("a");
          link.className = "button button--primary";
          link.href = blobURL;
          link.download = "export.zip";
          link.click();
        });
      } else if (message.type === "content-to-save") {
        let zip = new JSZip();
        message.contentToSave.forEach((data, idx) => {
          let { bytesMainImage, name, imageExtension, language } = data;
          let blob = new Blob([bytesMainImage]);
          zip.folder(`${language}`).file(`${name}.${imageExtension}`, blob);
        });
        zip.generateAsync({ type: "blob" }).then((content) => {
          const blobURL = window.URL.createObjectURL(content);
          const link = document.createElement("a");
          link.className = "button button--primary";
          link.href = blobURL;
          link.download = "export.zip";
          link.click();
        });
      } else if (message.type === "current-lang") {
        document.getElementById("changingLanguage").innerHTML = message.currentLanguage;
      } else if (message.type === "start-to-translate") {
        document.getElementById("changingLanguage").classList.remove = "d-none";
        document.getElementById("changingLanguage").classList.add = "d-block";
      } else if (message.type === "translation-ended") {
        document.getElementById("changingLanguage").classList.add = "d-none";
        document.getElementById("changingLanguage").classList.remove = "d-block";
      }
    };

    document.getElementById("dictionaryFile").onchange = (e) => loadFile(e, "serializedDictionary");
    document.getElementById("dictionaryFile").onclick = (e) => {
      e.target.value = null;
    };

    document.getElementById("changingLanguage").innerText = language;

    document.getElementById("translate").onclick = () => {
      document.getElementById("translate").disabled = true;
      const settings = getSettings();
      parent.postMessage({ pluginMessage: { type: "translate-and-save", settings } }, "*");
    };

    document.getElementById("copy").onclick = () => {
      document.getElementById("copy").disabled = true;
      const settings = getSettings();
      parent.postMessage({ pluginMessage: { type: "copy", settings } }, "*");
    };

    document.getElementById("save").onclick = () => {
      document.getElementById("save").disabled = true;
      const settings = getSettings();
      parent.postMessage({ pluginMessage: { type: "save", settings } }, "*");
    };

    parent.postMessage({ pluginMessage: { type: "load-settings" } }, "*");

    function getSettings() {
      const result = {};
      fields.forEach((field) => {
        const element = document.getElementById(field);
        if (element.type === "checkbox") {
          result[field] = element.checked;
        } else {
          result[field] = element.value;
        }
      });
      return result;
    }

    function loadFile(e, holderId, callback) {
      const file = e.target.files[0];
      if (!file) {
        return;
      }
      const reader = new FileReader();
      reader.onload = (e) => {
        document.getElementById(holderId).value = e.target.result;
        if (callback !== undefined) {
          callback.apply();
        }
      };
      reader.readAsText(file);
    }

    function focusNode(id) {
      parent.postMessage({ pluginMessage: { type: "focus-node", id } }, "*");
    }
  </script>
</body>
